<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="haru.park.mapper.UserCouponMapper">

  <select id="selectByUserIdWithCoupon" resultType="haru.park.dto.UserCouponItemDto">
    SELECT uc.id AS id, c.id AS couponId, c.code AS code, c.name AS name, c.discount_type AS discountType, c.discount_value AS discountValue,
           c.min_order_amount AS minOrderAmount, c.max_discount_amount AS maxDiscountAmount, c.valid_from AS validFrom, c.valid_until AS validUntil,
           uc.used_at AS usedAt, uc.created_at AS createdAt
    FROM user_coupons uc
    JOIN coupons c ON uc.coupon_id = c.id
    WHERE uc.user_id = #{userId}
    ORDER BY uc.used_at IS NULL DESC, uc.created_at DESC
  </select>

  <select id="selectByUserIdAndCouponId" resultType="haru.park.entity.UserCoupon">
    SELECT id, user_id AS userId, coupon_id AS couponId, used_at AS usedAt, order_id AS orderId, created_at AS createdAt
    FROM user_coupons
    WHERE user_id = #{userId} AND coupon_id = #{couponId}
    LIMIT 1
  </select>

  <insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO user_coupons (user_id, coupon_id)
    VALUES (#{userId}, #{couponId})
  </insert>
</mapper>
